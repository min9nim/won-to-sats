<head>
    <title>won-to-sats</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
</head>
<style>
    body {
        padding: 20px;
    }

    section {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    h2, h3, h4 {
        margin-top: 10px;
        margin-bottom: 10px;
        margin: 5px 0;
    }

    hr {
        margin: 20px 0;
        width: 100%;
    }


    .group {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .item {
        display: flex;
        flex-direction: row;
        align-items: center;
        font-size: 16px;
        gap: 5px;
    }

    .sats-input, .won-input, .ps-input, .pw-input {
        text-align: right;
        font-size: 16px;
        width: 100%;
    }

    .group {
        margin: 10px 0;
        padding: 5px 20px 20px 20px;
        width: 230px;
        border: 1px solid #ddd;
    }

    .label {
        width: 190px;
    }

    .won-result, .sats-result {
        font-weight: bold;
        width: 100%;
        text-align: right;
    }
</style>
<body>
<section>
    <h3 class="time"></h3>
    <h3 class="price"></h3>
    <hr/>
    <div class="group">
        <h2>won to sats</h2>
        <div class="item">
            <div class="label">₩:</div>
            <input class="won-input" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"/>
        </div>
        <div class="item">
            <div class="label">p(%):</div>
            <input class="pw-input" oninput="this.value = this.value.replace(/[^0-9.-]/g, '').replace(/(\..*)\./g, '$1');"/>
        </div>
        <div class="item">
            <div class="label">=></div>
            <div class="sats-result"></div>
            sats
        </div>
    </div>

    <div class="group">
        <h2>sats to won</h2>
        <div class="item">
            <div class="label">sats:</div>
            <input class="sats-input" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"/>
        </div>
        <div class="item">
            <div class="label">p(%):</div>
            <input class="ps-input" oninput="this.value = this.value.replace(/[^0-9.-]/g, '').replace(/(\..*)\./g, '$1');"/>
        </div>
        <div class="item">
            <div class="label">=></div>
            <div class="won-result"></div>
            ₩
        </div>
    </div>
</section>
<script>
    const unit = 100000000
    let price
    let wonValue, satsValue
    let pwValue, psValue

    function syncSats(value, p) {
        console.log({value, p})

        const sats = value * unit / price
        const pSats = Math.floor(sats * ((100 + p) / 100))
        console.log({value, pSats})
        document.querySelector('.sats-result').innerHTML = pSats.toLocaleString()
    }

    function syncWon(value, p) {
        const won = value * price / unit
        const pWon = Math.floor(won * ((100 + p) / 100))
        document.querySelector('.won-result').innerHTML = pWon.toLocaleString()
    }

    async function fetchPrice() {
        price = await fetch('https://api.upbit.com/v1/candles/days?market=KRW-BTC&count=1').then(res => res.json()).then(res => res[0]['trade_price'])
        document.querySelector('.price').innerHTML = `Upbit BTC: ₩ ${price.toLocaleString()}`
        document.querySelector('.time').innerHTML = (new Date()).toLocaleString('ko-KR', {
            hour12: false,
            year: 'numeric',
            month: 'numeric',
            day: 'numeric',
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
        })
        syncSats(wonValue, pwValue)
        syncWon(satsValue, psValue)
    }

    function loadValue() {
        if (!wonValue) {
            wonValue = Number(localStorage.getItem('wonValue')) || 30000
            document.querySelector('.won-input').value = wonValue.toLocaleString()
            syncSats(wonValue, pwValue)
        }
        if (!satsValue) {
            satsValue = Number(localStorage.getItem('satsValue')) || 100000
            document.querySelector('.sats-input').value = satsValue.toLocaleString()
            syncSats(satsValue, psValue)
        }
    }

    function loadPValue() {
        if (!pwValue) {
            const initValue = Number(localStorage.getItem('pwValue'))
            pwValue = Number.isNaN(initValue) ? 30000 : initValue
            document.querySelector('.pw-input').value = pwValue.toLocaleString()
            syncSats(wonValue, pwValue)
        }
        if (!psValue) {
            const initValue = Number(localStorage.getItem('psValue'))
            psValue = Number.isNaN(initValue) ? 0 : initValue
            document.querySelector('.ps-input').value = psValue.toLocaleString()
            syncSats(satsValue, psValue)
        }
    }


    async function init() {
        loadValue()
        loadPValue()
        await fetchPrice()
        document.querySelector('.won-input').addEventListener('keyup', (e) => {
            const value = Number(e.target.value.replaceAll(',', ''))
            document.querySelector('.won-input').value = value.toLocaleString()
            wonValue = value
            localStorage.setItem('wonValue', value)
            syncSats(value, pwValue)
        })
        document.querySelector('.sats-input').addEventListener('keyup', (e) => {
            const value = Number(e.target.value.replaceAll(',', ''))
            document.querySelector('.sats-input').value = value.toLocaleString()
            satsValue = value
            localStorage.setItem('satsValue', value)
            syncWon(value, psValue)
        })
        document.querySelector('.pw-input').addEventListener('keyup', (e) => {
            const value = Number(e.target.value.replaceAll(',', ''))
            pwValue = value
            localStorage.setItem('pwValue', value)
            syncSats(wonValue, value)
        })
        document.querySelector('.ps-input').addEventListener('keyup', (e) => {
            const value = Number(e.target.value.replaceAll(',', ''))
            psValue = value
            localStorage.setItem('psValue', value)
            syncWon(satsValue, value)
        })
    }

    init()

    setInterval(fetchPrice, 1000)


</script>
</body>
